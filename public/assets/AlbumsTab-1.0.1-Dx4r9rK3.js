import{r as g,j as e,l as w,u as O,a as B}from"./index-1.0.1-2Be6sSou.js";const F=a=>{if(a&&typeof a=="object"){const t=a;return{current:typeof t.current=="number"?t.current:void 0,total:typeof t.total=="number"?t.total:void 0,message:typeof t.message=="string"?t.message:void 0}}},U=({albumId:a,imageId:t,onComplete:n,variant:u="default"})=>{const[c,i]=g.useState(!1),[l,m]=g.useState(""),[f,h]=g.useState(0),[E,A]=g.useState(null),S=g.useRef(null),x=t?`image #${t}`:`album #${a}`;g.useEffect(()=>()=>{S.current&&window.clearInterval(S.current)},[]);const N=()=>{i(!1),h(0),A(null),S.current&&(window.clearInterval(S.current),S.current=null)},p=v=>{m(v),N()},I=v=>{S.current=window.setInterval(async()=>{try{const y=await fetch(`/api/labeling/tasks/${v}`,{credentials:"include"});if(!y.ok)throw new Error("Failed to fetch task status");const _=await y.json(),r=_.state??"PENDING";if(r==="SUCCESS"){if(m("Labeling complete!"),h(100),S.current&&(window.clearInterval(S.current),S.current=null),n)try{await n()}catch(s){w.error("Labeling onComplete handler failed:",s)}setTimeout(()=>{m(""),N()},1500)}else if(r==="FAILURE"){const s=_.result&&typeof _.result=="object"&&"message"in _.result?String(_.result.message):"Labeling failed";p(s)}else if(r==="PROGRESS"){const s=F(_.progress)??F(_.result)??{},{current:d,total:b,message:o}=s;typeof d=="number"&&typeof b=="number"&&b>0?(h(Math.min(100,Math.round(d/b*100))),m(`Labeled ${d} of ${b} images...`)):m(o?String(o):"Labeling in progress...")}else m(`Status: ${r}`)}catch(y){w.error("Polling error:",y),p("Failed to poll labeling status")}},2e3)},D=async()=>{if(!c){if(!a&&!t){p("Missing album or image identifier");return}i(!0),m("Starting labeling..."),h(0);try{const v=t?`/api/labeling/image/${t}`:`/api/labeling/album/${a}`,y={prompt_type:"sd_training",...a?{force:!1}:{}},_=await fetch(v,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(y)}),r=await _.json().catch(()=>({}));if(_.status===202&&r.task_id)A(r.task_id),m("Labeling queued..."),I(r.task_id);else if(_.ok)m("Labeling complete!"),h(100),n&&await Promise.resolve(n()),setTimeout(()=>{m(""),N()},1500);else{const s=typeof r.error=="string"?r.error:"Labeling failed";p(s)}}catch(v){w.error("Labeling request failed:",v),p("Failed to start labeling task")}}};return u==="compact"?e.jsxs("div",{className:"labeling-panel compact",children:[e.jsx("button",{className:"labeling-trigger",onClick:()=>void D(),disabled:c,title:c?"Labeling in progress":"Label this image",children:c?"Labeling…":"Label image"}),l&&e.jsx("p",{className:"status-text",children:l})]}):e.jsxs("div",{className:"labeling-panel",children:[e.jsx("h3",{children:"🏷️ AI Labeling"}),e.jsxs("p",{className:"help-text",children:["Trigger Claude to caption, tag, and classify ",x,"."]}),e.jsxs("div",{className:"labeling-actions",children:[e.jsx("button",{className:"labeling-button",onClick:()=>void D(),disabled:c,children:c?"Labeling…":"Start Labeling"}),E&&e.jsxs("span",{className:"task-id","aria-live":"polite",children:["Task ID: ",E]})]}),e.jsxs("div",{className:"labeling-progress",children:[e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${f}%`}})}),l&&e.jsx("p",{className:"status-text",children:l})]})]})},P=(a,t)=>{g.useEffect(()=>{const n=new AbortController,u=a(n.signal);return()=>{n.abort(),u&&u()}},t)},M=a=>({images:a,selectedImages:new Set,nsfwSetting:"blur",labelInputs:{},editingLabel:null,labelError:null,loadingStates:{removingImages:!1,addingLabel:new Set,deletingLabel:new Set,editingLabel:!1},optimisticUpdates:{pendingLabelAdds:new Map,pendingLabelDeletes:new Set,pendingLabelEdits:new Map}}),k=(a,t)=>`${a}-${t}`;function $(a,t){switch(t.type){case"RESET":return M(t.images);case"TOGGLE_IMAGE_SELECTION":{const n=new Set(a.selectedImages);return n.has(t.imageId)?n.delete(t.imageId):n.add(t.imageId),{...a,selectedImages:n}}case"CLEAR_SELECTED_IMAGES":return{...a,selectedImages:new Set};case"SET_NSFW_SETTING":return{...a,nsfwSetting:t.setting};case"UPDATE_LABEL_INPUT":return{...a,labelInputs:{...a.labelInputs,[t.imageId]:t.value}};case"CLEAR_LABEL_INPUT":{const n={...a.labelInputs};return delete n[t.imageId],{...a,labelInputs:n}}case"SET_LABEL_ERROR":return{...a,labelError:t.error};case"START_EDITING_LABEL":return{...a,editingLabel:{imageId:t.imageId,labelId:t.labelId,value:t.value},labelError:null};case"UPDATE_EDITING_LABEL":return a.editingLabel?{...a,editingLabel:{...a.editingLabel,value:t.value}}:a;case"CANCEL_EDITING_LABEL":return{...a,editingLabel:null,labelError:null};case"OPTIMISTIC_ADD_LABEL":{const n=new Map(a.optimisticUpdates.pendingLabelAdds);return n.set(t.imageId,t.labelText),{...a,optimisticUpdates:{...a.optimisticUpdates,pendingLabelAdds:n}}}case"OPTIMISTIC_DELETE_LABEL":{const n=k(t.imageId,t.labelId),u=new Set(a.optimisticUpdates.pendingLabelDeletes);return u.add(n),{...a,optimisticUpdates:{...a.optimisticUpdates,pendingLabelDeletes:u}}}case"OPTIMISTIC_EDIT_LABEL":{const n=k(t.imageId,t.labelId),u=new Map(a.optimisticUpdates.pendingLabelEdits);return u.set(n,t.newText),{...a,optimisticUpdates:{...a.optimisticUpdates,pendingLabelEdits:u}}}case"CONFIRM_ADD_LABEL":{const n=new Map(a.optimisticUpdates.pendingLabelAdds);n.delete(t.imageId);const u=a.images.map(c=>c.id===t.imageId?{...c,labels:[...c.labels||[],t.newLabel],label_count:(c.label_count||0)+1,manual_label_count:(c.manual_label_count||0)+1}:c);return{...a,images:u,optimisticUpdates:{...a.optimisticUpdates,pendingLabelAdds:n}}}case"CONFIRM_DELETE_LABEL":{const n=k(t.imageId,t.labelId),u=new Set(a.optimisticUpdates.pendingLabelDeletes);u.delete(n);const c=a.images.map(i=>i.id===t.imageId?{...i,labels:(i.labels||[]).filter(l=>l.id!==t.labelId),label_count:Math.max((i.label_count||0)-1,0),manual_label_count:Math.max((i.manual_label_count||0)-1,0)}:i);return{...a,images:c,optimisticUpdates:{...a.optimisticUpdates,pendingLabelDeletes:u}}}case"CONFIRM_EDIT_LABEL":{const n=k(t.imageId,t.labelId),u=new Map(a.optimisticUpdates.pendingLabelEdits);u.delete(n);const c=a.images.map(i=>i.id===t.imageId?{...i,labels:(i.labels||[]).map(l=>l.id===t.labelId?{...l,label_text:t.newText}:l)}:i);return{...a,images:c,optimisticUpdates:{...a.optimisticUpdates,pendingLabelEdits:u}}}case"ROLLBACK_ADD_LABEL":{const n=new Map(a.optimisticUpdates.pendingLabelAdds);return n.delete(t.imageId),{...a,optimisticUpdates:{...a.optimisticUpdates,pendingLabelAdds:n}}}case"ROLLBACK_DELETE_LABEL":{const n=k(t.imageId,t.labelId),u=new Set(a.optimisticUpdates.pendingLabelDeletes);u.delete(n);const c=a.images.map(i=>i.id===t.imageId?{...i,labels:[...i.labels||[],t.originalLabel],label_count:(i.label_count||0)+1,manual_label_count:(i.manual_label_count||0)+1}:i);return{...a,images:c,optimisticUpdates:{...a.optimisticUpdates,pendingLabelDeletes:u}}}case"ROLLBACK_EDIT_LABEL":{const n=k(t.imageId,t.labelId),u=new Map(a.optimisticUpdates.pendingLabelEdits);u.delete(n);const c=a.images.map(i=>i.id===t.imageId?{...i,labels:(i.labels||[]).map(l=>l.id===t.labelId?{...l,label_text:t.originalText}:l)}:i);return{...a,images:c,optimisticUpdates:{...a.optimisticUpdates,pendingLabelEdits:u}}}case"SET_REMOVING_IMAGES":return{...a,loadingStates:{...a.loadingStates,removingImages:t.isLoading}};case"SET_ADDING_LABEL":{const n=new Set(a.loadingStates.addingLabel);return t.isLoading?n.add(t.imageId):n.delete(t.imageId),{...a,loadingStates:{...a.loadingStates,addingLabel:n}}}case"SET_DELETING_LABEL":{const n=k(t.imageId,t.labelId),u=new Set(a.loadingStates.deletingLabel);return t.isLoading?u.add(n):u.delete(n),{...a,loadingStates:{...a.loadingStates,deletingLabel:u}}}case"SET_EDITING_LABEL_LOADING":return{...a,loadingStates:{...a.loadingStates,editingLabel:t.isLoading}};case"UPDATE_IMAGES":return{...a,images:t.images};default:return a}}function K(a){const{albumId:t,initialImages:n,onRefresh:u,onRefreshAnalytics:c}=a,[i,l]=g.useReducer($,n,M),m=g.useRef(null);g.useEffect(()=>(l({type:"RESET",images:n}),m.current&&m.current.abort(),m.current=new AbortController,()=>{m.current&&m.current.abort()}),[t,n]);const f=g.useCallback(async()=>{await Promise.all([u(),c()])},[u,c]),h=g.useCallback(r=>{l({type:"TOGGLE_IMAGE_SELECTION",imageId:String(r)})},[]),E=g.useCallback(r=>{l({type:"SET_NSFW_SETTING",setting:r})},[]),A=g.useCallback((r,s)=>{l({type:"UPDATE_LABEL_INPUT",imageId:r,value:s})},[]),S=g.useCallback(async()=>{var r;if(i.selectedImages.size!==0){l({type:"SET_REMOVING_IMAGES",isLoading:!0});try{const s=(r=m.current)==null?void 0:r.signal;await Promise.all(Array.from(i.selectedImages).map(d=>fetch(`/api/albums/${t}/images/${d}`,{method:"DELETE",credentials:"include",signal:s}).catch(b=>{b.name!=="AbortError"&&w.error(`Failed to remove image ${d}`,b)}))),l({type:"CLEAR_SELECTED_IMAGES"}),await f()}catch(s){s.name!=="AbortError"&&w.error("Failed to remove images",s)}finally{l({type:"SET_REMOVING_IMAGES",isLoading:!1})}}},[i.selectedImages,t,f]),x=g.useCallback(async r=>{var d;const s=(i.labelInputs[r]||"").trim();if(!s){l({type:"SET_LABEL_ERROR",error:"Label text cannot be empty."});return}l({type:"SET_LABEL_ERROR",error:null}),l({type:"SET_ADDING_LABEL",imageId:r,isLoading:!0}),l({type:"OPTIMISTIC_ADD_LABEL",imageId:r,labelText:s});try{const b=(d=m.current)==null?void 0:d.signal,o=await fetch(`/api/images/${r}/labels`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",signal:b,body:JSON.stringify({text:s,type:"manual"})});if(!o.ok){const j=await o.json().catch(()=>({}));throw new Error(typeof j.error=="string"?j.error:"Failed to add label")}const C=await o.json();l({type:"CONFIRM_ADD_LABEL",imageId:r,newLabel:C}),l({type:"CLEAR_LABEL_INPUT",imageId:r}),await f()}catch(b){if(b.name!=="AbortError"){l({type:"ROLLBACK_ADD_LABEL",imageId:r});const o=b instanceof Error?b.message:"Failed to add label";l({type:"SET_LABEL_ERROR",error:o}),w.error("Failed to add label:",b)}}finally{l({type:"SET_ADDING_LABEL",imageId:r,isLoading:!1})}},[i.labelInputs,f]),N=g.useCallback(async(r,s)=>{var o,C;if(!window.confirm("Remove this label?"))return;const d=i.images.find(j=>j.id===r),b=(o=d==null?void 0:d.labels)==null?void 0:o.find(j=>j.id===s);if(b){l({type:"SET_LABEL_ERROR",error:null}),l({type:"SET_DELETING_LABEL",imageId:r,labelId:s,isLoading:!0}),l({type:"OPTIMISTIC_DELETE_LABEL",imageId:r,labelId:s});try{const j=(C=m.current)==null?void 0:C.signal,L=await fetch(`/api/images/${r}/labels/${s}`,{method:"DELETE",credentials:"include",signal:j});if(!L.ok){const R=await L.json().catch(()=>({}));throw new Error(typeof R.error=="string"?R.error:"Failed to remove label")}l({type:"CONFIRM_DELETE_LABEL",imageId:r,labelId:s}),await f()}catch(j){if(j.name!=="AbortError"){l({type:"ROLLBACK_DELETE_LABEL",imageId:r,labelId:s,originalLabel:b});const L=j instanceof Error?j.message:"Failed to remove label";l({type:"SET_LABEL_ERROR",error:L}),w.error("Failed to remove label:",j)}}finally{l({type:"SET_DELETING_LABEL",imageId:r,labelId:s,isLoading:!1})}}},[i.images,f]),p=g.useCallback((r,s)=>{l({type:"START_EDITING_LABEL",imageId:r,labelId:s.id,value:s.label_text})},[]),I=g.useCallback(r=>{l({type:"UPDATE_EDITING_LABEL",value:r})},[]),D=g.useCallback(()=>{l({type:"CANCEL_EDITING_LABEL"})},[]),v=g.useCallback(async()=>{var C,j;if(!i.editingLabel)return;const r=i.editingLabel.value.trim();if(!r){l({type:"SET_LABEL_ERROR",error:"Label text cannot be empty."});return}const{imageId:s,labelId:d}=i.editingLabel,b=i.images.find(L=>L.id===s),o=(C=b==null?void 0:b.labels)==null?void 0:C.find(L=>L.id===d);if(o){l({type:"SET_LABEL_ERROR",error:null}),l({type:"SET_EDITING_LABEL_LOADING",isLoading:!0}),l({type:"OPTIMISTIC_EDIT_LABEL",imageId:s,labelId:d,newText:r});try{const L=(j=m.current)==null?void 0:j.signal,R=await fetch(`/api/images/${s}/labels/${d}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",signal:L,body:JSON.stringify({text:r})});if(!R.ok){const G=await R.json().catch(()=>({}));throw new Error(typeof G.error=="string"?G.error:"Failed to update label")}l({type:"CONFIRM_EDIT_LABEL",imageId:s,labelId:d,newText:r}),l({type:"CANCEL_EDITING_LABEL"}),await f()}catch(L){if(L.name!=="AbortError"){l({type:"ROLLBACK_EDIT_LABEL",imageId:s,labelId:d,originalText:o.label_text});const R=L instanceof Error?L.message:"Failed to update label";l({type:"SET_LABEL_ERROR",error:R}),w.error("Failed to update label:",L)}}finally{l({type:"SET_EDITING_LABEL_LOADING",isLoading:!1})}}},[i.editingLabel,i.images,f]),y=g.useCallback(r=>i.loadingStates.addingLabel.has(r),[i.loadingStates.addingLabel]),_=g.useCallback((r,s)=>i.loadingStates.deletingLabel.has(k(r,s)),[i.loadingStates.deletingLabel]);return{state:i,actions:{toggleImageSelection:h,setNsfwSetting:E,updateLabelInput:A,removeSelectedImages:S,addLabel:x,deleteLabel:N,startEditingLabel:p,updateEditingLabel:I,cancelEditingLabel:D,saveEditedLabel:v},isLoading:{addingLabel:y,deletingLabel:_}}}const W=({isAdmin:a})=>{const t=O(),[n,u]=g.useState([]),[c,i]=g.useState(null),[l,m]=g.useState(!1),[f,h]=g.useState(null),[E,A]=g.useState("all"),[S,x]=g.useState(null);P(s=>{N(s)},[]);const N=async s=>{try{const d=await B.albums.getAll(s),b=Array.isArray(d)?d.map(o=>({...o,id:String(o.id)})):[];u(b)}catch(d){if(d instanceof Error&&d.name==="AbortError")return;w.error("Failed to fetch albums:",d)}},p=async(s,d)=>{if(!a)return null;try{const b=await B.albums.getAnalytics(s,d);return h(b),b}catch(b){return b instanceof Error&&b.name==="AbortError"||(w.error("Failed to fetch album analytics:",b),h(null)),null}},I=async(s,d)=>{try{const o=await B.albums.getById(s,a,d),C=Array.isArray(o.images)?o.images.map(L=>{const G=(Array.isArray(L.labels)?L.labels:[]).map(T=>({id:Number(T.id),image_id:Number(T.image_id),label_text:T.label_text,confidence:T.confidence===null||typeof T.confidence>"u"?null:Number(T.confidence),label_type:T.label_type??null,source_model:T.source_model??null,source_prompt:T.source_prompt??null,created_by:T.created_by??null,created_at:T.created_at??null}));return{id:typeof L.id=="string"?parseInt(L.id,10):L.id,filename:L.filename,thumbnail_path:L.thumbnail_path??null,is_nsfw:L.is_nsfw,labels:G,label_count:typeof L.label_count=="number"?L.label_count:G.length,manual_label_count:typeof L.manual_label_count=="number"?L.manual_label_count:void 0}}):[],j={id:String(o.id),name:o.name,description:o.description,album_type:o.album_type,image_count:o.image_count??C.length,created_at:o.created_at??"",updated_at:o.updated_at??"",is_set_template:o.is_set_template,csv_data:o.csv_data,base_prompt:o.base_prompt,prompt_template:o.prompt_template,style_suffix:o.style_suffix,example_theme:o.example_theme,lora_config:o.lora_config,template_item_count:o.template_item_count,generation_prompt:o.generation_prompt,generation_config:o.generation_config,images:C};return i(j),a?await p(String(o.id)):h(null),j}catch(b){return b instanceof Error&&b.name==="AbortError"||(w.error("Failed to fetch album details:",b),h(null)),null}},D=async s=>{await I(s)},v=async(s,d,b="manual")=>{if(a)try{const o=await B.albums.create(s,d,b);o.success?(t.success("Album created successfully!"),N(),m(!1)):t.error("Failed to create album: "+(o.error??"Unknown error"))}catch(o){w.error("Failed to create album:",o),t.error("Error creating album")}},y=async s=>{if(a&&window.confirm("Are you sure you want to delete this album?"))try{const d=await B.albums.delete(s);d.success?(t.success("Album deleted successfully"),N(),(c==null?void 0:c.id)===s&&(i(null),h(null))):t.error("Failed to delete album: "+(d.error??"Unknown error"))}catch(d){w.error("Failed to delete album:",d),t.error("Error deleting album")}},_=(s,d)=>{d.stopPropagation(),x(s)},r=n.filter(s=>E==="all"?!0:E==="sets"?s.is_set_template===!0:E==="regular"?!s.is_set_template:!0);return c?e.jsx(q,{album:c,onBack:()=>i(null),isAdmin:a,onDelete:y,onRefresh:()=>I(String(c.id)),analytics:f,onRefreshAnalytics:async()=>{await p(String(c.id))}}):e.jsxs("div",{className:"albums-tab",children:[e.jsxs("div",{className:"albums-header",children:[e.jsx("h2",{children:"Albums"}),e.jsxs("div",{className:"albums-header-actions",children:[e.jsxs("div",{className:"album-filter-buttons",children:[e.jsx("button",{className:`filter-btn ${E==="all"?"active":""}`,onClick:()=>A("all"),children:"All Albums"}),e.jsx("button",{className:`filter-btn ${E==="sets"?"active":""}`,onClick:()=>A("sets"),children:"Set Templates"}),e.jsx("button",{className:`filter-btn ${E==="regular"?"active":""}`,onClick:()=>A("regular"),children:"Regular Albums"})]}),a&&e.jsx("button",{className:"create-album-btn",onClick:()=>m(!0),children:"Create Album"})]})]}),e.jsx("div",{className:"albums-grid",children:r.map(s=>e.jsxs("div",{className:"album-card",onClick:()=>D(s.id),children:[e.jsx("div",{className:"album-cover",children:s.images&&s.images.length>0?e.jsx("img",{src:`/api/images/${s.images[0].id}/thumbnail`,alt:s.name}):e.jsxs("div",{className:"album-placeholder",children:[s.image_count||0," images"]})}),e.jsxs("div",{className:"album-info",children:[e.jsxs("div",{className:"album-title-row",children:[e.jsx("h3",{children:s.name}),s.is_set_template&&e.jsx("span",{className:"set-template-badge",children:"Set Template"})]}),e.jsx("p",{children:s.description||"No description"}),s.is_set_template&&s.template_item_count&&e.jsxs("p",{className:"template-info",children:[s.template_item_count," template items"]}),e.jsxs("div",{className:"album-meta",children:[e.jsxs("span",{children:[s.image_count||0," images"]}),e.jsx("span",{className:"album-type",children:s.album_type||"manual"})]}),a&&e.jsxs("div",{className:"album-actions",children:[s.is_set_template&&e.jsx("button",{className:"generate-batch-btn",onClick:d=>_(s,d),children:"Generate Batch"}),e.jsx("button",{className:"delete-album-btn",onClick:d=>{d.stopPropagation(),y(s.id)},children:"Delete"})]})]})]},s.id))}),r.length===0&&n.length>0&&e.jsx("div",{className:"empty-state",children:e.jsxs("p",{children:["No ",E==="sets"?"set template":E==="regular"?"regular":""," albums found."]})}),n.length===0&&e.jsx("div",{className:"empty-state",children:e.jsxs("p",{children:["No albums yet. ",a?"Create your first album!":"Albums will appear here."]})}),l&&e.jsx(V,{onClose:()=>m(!1),onCreate:v}),S&&e.jsx(z,{album:S,onClose:()=>x(null),onSuccess:()=>{x(null),t.success("Batch generation started!")}})]})},q=({album:a,onBack:t,isAdmin:n,onRefresh:u,analytics:c,onRefreshAnalytics:i})=>{const{state:l,actions:m,isLoading:f}=K({albumId:a.id,initialImages:a.images||[],onRefresh:u,onRefreshAnalytics:i}),{images:h,selectedImages:E,nsfwSetting:A,labelInputs:S,editingLabel:x,labelError:N}=l;return e.jsxs("div",{className:"album-detail",children:[e.jsxs("div",{className:"album-detail-header",children:[e.jsx("button",{className:"back-btn",onClick:t,children:"← Back"}),e.jsx("h2",{children:a.name}),e.jsxs("div",{className:"nsfw-filter",children:[e.jsx("label",{children:"NSFW:"}),e.jsxs("select",{value:A,onChange:p=>m.setNsfwSetting(p.target.value),children:[e.jsx("option",{value:"hide",children:"Hide"}),e.jsx("option",{value:"blur",children:"Blur"}),e.jsx("option",{value:"show",children:"Show"})]})]}),n&&E.size>0&&e.jsxs("button",{className:"remove-images-btn",onClick:m.removeSelectedImages,children:["Remove ",E.size," images"]})]}),n&&N&&e.jsx("div",{className:"label-error",children:N}),n&&c&&e.jsxs("div",{className:"album-analytics",children:[e.jsxs("div",{className:"analytics-cards",children:[e.jsxs("div",{className:"analytics-card",children:[e.jsx("span",{className:"analytics-label",children:"Images"}),e.jsx("strong",{children:c.image_count})]}),e.jsxs("div",{className:"analytics-card",children:[e.jsx("span",{className:"analytics-label",children:"Labeled"}),e.jsxs("strong",{children:[c.images_with_labels,"/",c.image_count]}),e.jsxs("small",{children:[c.coverage.labels_percent,"%"]})]}),e.jsxs("div",{className:"analytics-card",children:[e.jsx("span",{className:"analytics-label",children:"Manual Coverage"}),e.jsxs("strong",{children:[c.coverage.manual_percent,"%"]})]}),e.jsxs("div",{className:"analytics-card",children:[e.jsx("span",{className:"analytics-label",children:"Avg. Labels/Image"}),e.jsx("strong",{children:c.average_labels_per_image})]}),e.jsxs("div",{className:"analytics-card",children:[e.jsx("span",{className:"analytics-label",children:"Unlabeled"}),e.jsx("strong",{children:c.unlabeled_images})]}),c.last_labeled_at&&e.jsxs("div",{className:"analytics-card",children:[e.jsx("span",{className:"analytics-label",children:"Last Labeled"}),e.jsx("strong",{children:new Date(c.last_labeled_at).toLocaleString()})]})]}),c.top_tags.length>0&&e.jsxs("div",{className:"analytics-top-tags",children:[e.jsx("h4",{children:"Top Tags"}),e.jsx("ul",{children:c.top_tags.map(p=>e.jsxs("li",{children:[e.jsx("span",{children:p.label_text}),e.jsx("span",{className:"tag-count",children:p.count})]},p.label_text))})]})]}),n&&e.jsx("div",{className:"album-actions",children:e.jsx(U,{albumId:a.id,onComplete:async()=>{await u(),await i()}})}),e.jsx("div",{className:"album-description",children:e.jsx("p",{children:a.description||"No description"})}),e.jsx("div",{className:"album-images-grid",children:h.map(p=>{const I=p.labels??[],D=String(p.id),v=S[p.id]??"",y=x&&x.imageId===p.id?x:null;return e.jsxs("div",{className:`image-card ${p.is_nsfw?"nsfw":""} ${A}`,onClick:()=>n&&m.toggleImageSelection(p.id),children:[n&&e.jsx("input",{type:"checkbox",checked:E.has(D),onChange:()=>m.toggleImageSelection(p.id),className:"image-checkbox"}),e.jsx("img",{src:`/api/images/${p.id}/thumbnail`,alt:p.filename,className:p.is_nsfw&&A==="blur"?"blurred":""}),p.is_nsfw&&e.jsx("div",{className:"nsfw-badge",children:"18+"}),I.length>0&&e.jsx("div",{className:"has-labels-badge",children:"🏷️"}),n&&e.jsxs(e.Fragment,{children:[e.jsx(U,{imageId:p.id,onComplete:async()=>{await u(),await i()},variant:"compact"}),e.jsxs("div",{className:"label-editor",children:[e.jsxs("div",{className:"label-chip-list",children:[I.length===0&&e.jsx("span",{className:"label-empty",children:"No labels yet."}),I.map(_=>{const r=y&&y.labelId===_.id,s=(_.label_type||"unknown").toLowerCase(),d=s==="caption",b=f.deletingLabel(p.id,_.id);return e.jsx("div",{className:`label-chip label-type-${s} ${r?"editing":""}`,children:r?e.jsxs(e.Fragment,{children:[e.jsx("input",{type:"text",value:(y==null?void 0:y.value)??"",onChange:o=>m.updateEditingLabel(o.target.value),disabled:l.loadingStates.editingLabel}),e.jsxs("div",{className:"label-chip-actions",children:[e.jsx("button",{type:"button",onClick:m.saveEditedLabel,disabled:l.loadingStates.editingLabel||!((y==null?void 0:y.value)??"").trim(),children:l.loadingStates.editingLabel?"Saving...":"Save"}),e.jsx("button",{type:"button",onClick:m.cancelEditingLabel,disabled:l.loadingStates.editingLabel,children:"Cancel"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{children:_.label_text}),e.jsxs("div",{className:"label-chip-actions",children:[!d&&e.jsx("button",{type:"button",onClick:()=>m.startEditingLabel(p.id,_),disabled:l.loadingStates.editingLabel,children:"Edit"}),e.jsx("button",{type:"button",onClick:()=>m.deleteLabel(p.id,_.id),disabled:b,children:b?"Removing...":"Remove"})]})]})},_.id)})]}),e.jsxs("form",{className:"label-add-form",onSubmit:_=>{_.preventDefault(),m.addLabel(p.id)},children:[e.jsx("input",{type:"text",placeholder:"Add manual tag",value:v,onChange:_=>m.updateLabelInput(p.id,_.target.value),disabled:f.addingLabel(p.id)}),e.jsx("button",{type:"submit",disabled:f.addingLabel(p.id)||!v.trim(),children:f.addingLabel(p.id)?"Adding...":"Add"})]})]})]})]},p.id)})}),h.length===0&&e.jsx("div",{className:"empty-album",children:e.jsx("p",{children:"This album is empty."})})]})},z=({album:a,onClose:t,onSuccess:n})=>{const u=O(),[c,i]=g.useState(""),[l,m]=g.useState(""),[f,h]=g.useState(""),[E,A]=g.useState(!1),S=async x=>{if(x.preventDefault(),!c.trim()){u.error("User theme is required");return}A(!0);try{const N={user_theme:c.trim()};if(l){const I=parseInt(l,10);isNaN(I)||(N.steps=I)}if(f){const I=parseInt(f,10);isNaN(I)||(N.seed=I)}const p=await B.albums.generateBatch(a.id,N);p.success?(u.success(`Batch generation started! ${a.template_item_count||0} jobs queued.`),n()):u.error(p.error||"Failed to start batch generation")}catch(N){w.error("Failed to generate batch:",N),u.error("Error starting batch generation")}finally{A(!1)}};return e.jsx("div",{className:"dialog-overlay",onClick:t,children:e.jsxs("div",{className:"dialog",onClick:x=>x.stopPropagation(),children:[e.jsxs("h2",{children:["Generate Batch: ",a.name]}),e.jsxs("p",{className:"dialog-description",children:["Generate ",a.template_item_count||0," images using this set template"]}),e.jsxs("form",{onSubmit:S,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"user-theme",children:"Art Style Theme (required):"}),e.jsx("input",{id:"user-theme",type:"text",value:c,onChange:x=>i(x.target.value),placeholder:a.example_theme||"e.g., gothic style with ravens",required:!0,disabled:E}),a.example_theme&&e.jsxs("small",{className:"form-hint",children:["Example: ",a.example_theme]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"steps",children:"Steps (optional):"}),e.jsx("input",{id:"steps",type:"number",value:l,onChange:x=>m(x.target.value),placeholder:"Leave empty to use album defaults",min:"1",max:"150",disabled:E})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"seed",children:"Seed (optional):"}),e.jsx("input",{id:"seed",type:"number",value:f,onChange:x=>h(x.target.value),placeholder:"Random seed for reproducibility",min:"0",max:"2147483647",disabled:E})]}),e.jsxs("div",{className:"dialog-actions",children:[e.jsx("button",{type:"submit",disabled:E||!c.trim(),children:E?"Starting...":"Start Generation"}),e.jsx("button",{type:"button",onClick:t,disabled:E,children:"Cancel"})]})]})]})})},V=({onClose:a,onCreate:t})=>{const[n,u]=g.useState(""),[c,i]=g.useState(""),[l,m]=g.useState("manual"),f=h=>{h.preventDefault(),n.trim()&&t(n.trim(),c.trim(),l)};return e.jsx("div",{className:"dialog-overlay",onClick:a,children:e.jsxs("div",{className:"dialog",onClick:h=>h.stopPropagation(),children:[e.jsx("h2",{children:"Create Album"}),e.jsxs("form",{onSubmit:f,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"album-name",children:"Album Name:"}),e.jsx("input",{id:"album-name",type:"text",value:n,onChange:h=>u(h.target.value),placeholder:"Enter album name",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"album-description",children:"Description:"}),e.jsx("textarea",{id:"album-description",value:c,onChange:h=>i(h.target.value),placeholder:"Enter album description (optional)",rows:3})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"album-type",children:"Album Type:"}),e.jsxs("select",{id:"album-type",value:l,onChange:h=>m(h.target.value),children:[e.jsx("option",{value:"manual",children:"Manual Collection"}),e.jsx("option",{value:"batch",children:"Generated Batch"}),e.jsx("option",{value:"set",children:"CSV Set"})]})]}),e.jsxs("div",{className:"dialog-actions",children:[e.jsx("button",{type:"submit",children:"Create Album"}),e.jsx("button",{type:"button",onClick:a,children:"Cancel"})]})]})]})})};export{W as default};
