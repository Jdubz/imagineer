import{r as l,l as m,j as e}from"./index-1.0.1-2Be6sSou.js";import{u as U}from"./usePolling-1.0.1-DYzHV6Ky.js";const M=n=>typeof n!="number"?0:Math.min(100,Math.max(0,n)),V=n=>{if(n){if(typeof n=="string")try{const p=JSON.parse(n);return p&&typeof p=="object"?p:void 0}catch{return}if(typeof n=="object")return n}},G=({isAdmin:n=!1})=>{const[p,T]=l.useState([]),[I,E]=l.useState([]),[F,y]=l.useState(!0),[k,u]=l.useState(null),[L,v]=l.useState(!1),[c,h]=l.useState({runId:null,content:"",status:null,logAvailable:!1,logPath:"",loading:!1,error:null}),x=l.useRef(null),[i,S]=l.useState(null),[r,g]=l.useState({name:"",description:"",album_ids:[],config:{steps:1e3,rank:4,learning_rate:1e-4,batch_size:1}}),j=l.useCallback(async()=>{if(n)try{y(!0);const s=await(await fetch("/api/training",{credentials:"include"})).json();T(s.training_runs||[])}catch(a){u("Failed to fetch training runs"),m.error("Error fetching training runs:",a)}finally{y(!1)}},[n]),w=l.useCallback(async()=>{if(n)try{const s=await(await fetch("/api/training/albums",{credentials:"include"})).json();E(s.albums||[])}catch(a){m.error("Error fetching albums:",a)}},[n]);l.useEffect(()=>{if(!n){y(!1);return}j().catch(a=>m.error("Error refreshing runs:",a)),w().catch(a=>m.error("Error refreshing albums:",a))},[w,j,n]);const N=l.useCallback(async a=>{const s=String(a);h(t=>({...t,loading:!0,error:null}));try{const t=await fetch(`/api/training/${s}/logs?tail=500`,{credentials:"include"});if(!t.ok)throw new Error(`Failed to fetch logs (status ${t.status})`);const o=await t.json();h(d=>({...d,runId:s,loading:!1,content:o.logs??"",status:o.status,logAvailable:o.log_available,logPath:o.log_path,error:null})),["running","queued"].includes(o.status)||h(d=>({...d,runId:null}))}catch(t){const o=t instanceof Error?t.message:"Failed to load logs";h(d=>({...d,loading:!1,error:o}))}},[]),R=l.useCallback(a=>{const s=String(a);h({runId:s,content:"",status:null,logAvailable:!1,logPath:"",loading:!0,error:null}),N(s).catch(t=>{const o=t instanceof Error?t.message:"Failed to load logs";h(d=>({...d,loading:!1,error:o}))})},[N]),D=l.useCallback(async()=>{c.runId&&await N(c.runId).catch(a=>{const s=a instanceof Error?a.message:"Failed to load logs";h(t=>({...t,loading:!1,error:s}))})},[c.runId,N]);U(D,{interval:5e3,enabled:c.runId!==null,pauseWhenHidden:!0}),l.useEffect(()=>()=>{x.current&&window.clearTimeout(x.current)},[]);const P=l.useCallback(()=>{h({runId:null,content:"",status:null,logAvailable:!1,logPath:"",loading:!1,error:null})},[]),C=l.useCallback((a,s,t)=>{var b;if(!a)return;const o=String(s),d=()=>{const f=document.createElement("textarea");f.value=a,f.style.position="fixed",f.style.opacity="0",document.body.appendChild(f),f.select();try{document.execCommand("copy")}finally{document.body.removeChild(f)}};(b=navigator==null?void 0:navigator.clipboard)!=null&&b.writeText?navigator.clipboard.writeText(a).catch(d):d(),x.current&&window.clearTimeout(x.current),S({runId:o,field:t}),x.current=window.setTimeout(()=>{S(null),x.current=null},2e3)},[]),z=async a=>{if(a.preventDefault(),!!n)try{const s=await fetch("/api/training",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(r)});if(s.ok)v(!1),g({name:"",description:"",album_ids:[],config:{steps:1e3,rank:4,learning_rate:1e-4,batch_size:1}}),j();else{const t=await s.json();u(t.error||"Failed to create training run")}}catch(s){u("Failed to create training run"),m.error("Error creating training run:",s)}},O=async a=>{if(n)try{const s=await fetch(`/api/training/${String(a)}/start`,{method:"POST",credentials:"include"});if(s.ok)j();else{const t=await s.json();u(t.error||"Failed to start training")}}catch(s){u("Failed to start training"),m.error("Error starting training:",s)}},$=async a=>{if(n)try{const s=await fetch(`/api/training/${String(a)}/cancel`,{method:"POST",credentials:"include"});if(s.ok)j();else{const t=await s.json();u(t.error||"Failed to cancel training")}}catch(s){u("Failed to cancel training"),m.error("Error cancelling training:",s)}},q=async a=>{if(n)try{const s=await fetch(`/api/training/${String(a)}/cleanup`,{method:"POST",credentials:"include"});if(s.ok)j();else{const t=await s.json();u(t.error||"Failed to cleanup training")}}catch(s){u("Failed to cleanup training"),m.error("Error cleaning up training:",s)}},A=a=>{switch(a){case"completed":return"#4CAF50";case"running":return"#2196F3";case"failed":return"#F44336";case"cancelled":return"#FF9800";case"queued":return"#FFC107";default:return"#9E9E9E"}},_=a=>a?new Date(a).toLocaleString():"N/A";return n?F?e.jsx("div",{className:"training-tab",children:e.jsx("div",{className:"loading",children:"Loading training runs..."})}):e.jsxs("div",{className:"training-tab",children:[e.jsxs("div",{className:"training-header",children:[e.jsx("h2",{children:"LoRA Training Pipeline"}),n&&e.jsx("button",{className:"create-button",onClick:()=>v(!0),children:"Create Training Run"})]}),k&&e.jsxs("div",{className:"error-message",children:[k,e.jsx("button",{onClick:()=>u(null),"aria-label":"Dismiss error",children:"×"})]}),e.jsx("div",{className:"training-runs",children:p.length===0?e.jsx("div",{className:"no-runs",children:e.jsxs("p",{children:["No training runs found. ",n&&"Create your first training run to get started!"]})}):p.map(a=>{const s=V(a.training_config),t=Array.isArray(s==null?void 0:s.album_ids)?s==null?void 0:s.album_ids:void 0,o=String(a.id),d=a.error_message??a.error??null,b=M(a.progress);return e.jsxs("div",{className:"training-run-card",children:[e.jsxs("div",{className:"run-header",children:[e.jsx("h3",{children:a.name||`Training run ${o}`}),e.jsx("span",{className:"status-badge",style:{backgroundColor:A(a.status)},children:a.status.toUpperCase()})]}),a.description&&e.jsx("p",{className:"run-description",children:a.description}),e.jsxs("div",{className:"run-details",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Progress:"})," ",b,"%"]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Created:"})," ",_(a.created_at)]}),a.started_at&&e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Started:"})," ",_(a.started_at)]}),a.completed_at&&e.jsxs("div",{className:"detail-item",children:[e.jsx("strong",{children:"Completed:"})," ",_(a.completed_at)]})]}),a.status==="running"&&typeof a.progress=="number"&&e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${b}%`}})}),e.jsxs("div",{className:"asset-section",children:[e.jsxs("div",{className:"asset-item",children:[e.jsxs("div",{className:"asset-header",children:[e.jsx("strong",{children:"Dataset directory"}),e.jsx("button",{type:"button",className:"copy-button",onClick:()=>C(a.dataset_path??"",a.id,"dataset"),children:"Copy"}),(i==null?void 0:i.runId)===o&&(i==null?void 0:i.field)==="dataset"&&e.jsx("span",{className:"copy-feedback",children:"Copied!"})]}),e.jsx("code",{children:a.dataset_path||"Unavailable"})]}),e.jsxs("div",{className:"asset-item",children:[e.jsxs("div",{className:"asset-header",children:[e.jsx("strong",{children:"Output directory"}),e.jsx("button",{type:"button",className:"copy-button",onClick:()=>C(a.output_path??"",a.id,"output"),children:"Copy"}),(i==null?void 0:i.runId)===o&&(i==null?void 0:i.field)==="output"&&e.jsx("span",{className:"copy-feedback",children:"Copied!"})]}),e.jsx("code",{children:a.output_path||"Unavailable"})]}),e.jsxs("div",{className:"asset-item",children:[e.jsxs("div",{className:"asset-header",children:[e.jsx("strong",{children:"Final checkpoint"}),a.final_checkpoint&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"copy-button",onClick:()=>C(a.final_checkpoint||"",a.id,"checkpoint"),children:"Copy"}),(i==null?void 0:i.runId)===o&&(i==null?void 0:i.field)==="checkpoint"&&e.jsx("span",{className:"copy-feedback",children:"Copied!"})]})]}),e.jsx("code",{children:a.final_checkpoint??"Generated after completion"})]}),s&&e.jsxs("div",{className:"asset-item",children:[e.jsx("div",{className:"asset-header",children:e.jsx("strong",{children:"Training configuration"})}),e.jsxs("div",{className:"config-summary",children:[typeof s.steps=="number"&&e.jsxs("span",{children:["Steps: ",s.steps]}),typeof s.rank=="number"&&e.jsxs("span",{children:["Rank: ",s.rank]}),typeof s.learning_rate=="number"&&e.jsxs("span",{children:["Learning rate: ",s.learning_rate]}),typeof s.batch_size=="number"&&e.jsxs("span",{children:["Batch size: ",s.batch_size]}),t&&t.length>0&&e.jsxs("span",{children:["Albums: ",t.join(", ")]})]})]})]}),d&&e.jsxs("div",{className:"error-details",children:[e.jsx("strong",{children:"Error:"})," ",d]}),n&&e.jsxs("div",{className:"run-actions",children:[a.status==="queued"&&e.jsx("button",{className:"action-button start",onClick:()=>O(a.id),children:"Start Training"}),(a.status==="queued"||a.status==="running")&&e.jsx("button",{className:"action-button cancel",onClick:()=>$(a.id),children:"Cancel"}),(a.status==="completed"||a.status==="failed")&&e.jsx("button",{className:"action-button cleanup",onClick:()=>q(a.id),children:"Cleanup"}),e.jsx("button",{className:"action-button logs",onClick:()=>R(a.id),children:"View Logs"})]})]},a.id)})}),L&&e.jsx("div",{className:"dialog-overlay",children:e.jsxs("div",{className:"dialog",children:[e.jsxs("div",{className:"dialog-header",children:[e.jsx("h3",{children:"Create Training Run"}),e.jsx("button",{className:"close-button",onClick:()=>v(!1),children:"×"})]}),e.jsxs("form",{onSubmit:z,className:"training-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"name",children:"Name *"}),e.jsx("input",{type:"text",id:"name",value:r.name,onChange:a=>g({...r,name:a.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",value:r.description,onChange:a=>g({...r,description:a.target.value}),rows:3})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Training Albums *"}),e.jsx("div",{className:"album-selection",children:I.map(a=>e.jsxs("label",{className:"album-checkbox",children:[e.jsx("input",{type:"checkbox",checked:r.album_ids.includes(a.id),onChange:s=>{s.target.checked?g({...r,album_ids:[...r.album_ids,a.id]}):g({...r,album_ids:r.album_ids.filter(t=>t!==a.id)})}}),e.jsx("span",{children:a.name})]},a.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"steps",children:"Training Steps"}),e.jsx("input",{type:"number",id:"steps",value:r.config.steps,onChange:a=>g({...r,config:{...r.config,steps:parseInt(a.target.value)}}),min:"100",max:"10000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"rank",children:"LoRA Rank"}),e.jsx("input",{type:"number",id:"rank",value:r.config.rank,onChange:a=>g({...r,config:{...r.config,rank:parseInt(a.target.value)}}),min:"1",max:"64"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"learning_rate",children:"Learning Rate"}),e.jsx("input",{type:"number",id:"learning_rate",value:r.config.learning_rate,onChange:a=>g({...r,config:{...r.config,learning_rate:parseFloat(a.target.value)}}),step:"0.0001",min:"0.0001",max:"0.01"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"batch_size",children:"Batch Size"}),e.jsx("input",{type:"number",id:"batch_size",value:r.config.batch_size,onChange:a=>g({...r,config:{...r.config,batch_size:parseInt(a.target.value)}}),min:"1",max:"8"})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",onClick:()=>v(!1),children:"Cancel"}),e.jsx("button",{type:"submit",disabled:r.album_ids.length===0,children:"Create Training Run"})]})]})]})}),c.runId&&e.jsx("div",{className:"dialog-overlay",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"dialog log-dialog",children:[e.jsxs("div",{className:"dialog-header",children:[e.jsx("h3",{children:"Training Logs"}),e.jsx("button",{className:"close-button",onClick:P,"aria-label":"Close logs",children:"×"})]}),e.jsxs("div",{className:"log-meta",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Run ID:"})," ",c.runId]}),c.status&&e.jsxs("div",{children:[e.jsx("strong",{children:"Status:"})," ",c.status.toUpperCase()]}),c.logPath&&e.jsxs("div",{className:"log-path",children:[e.jsx("strong",{children:"Log file:"})," ",c.logPath]})]}),e.jsx("div",{className:"log-body",children:c.loading?e.jsx("div",{className:"log-loading",children:"Loading logs..."}):c.error?e.jsx("div",{className:"log-error",children:c.error}):c.logAvailable?e.jsx("pre",{className:"log-content",children:c.content||"No log output yet."}):e.jsx("div",{className:"log-empty",children:"Logs are not available yet for this run."})})]})})]}):e.jsx("div",{className:"training-tab",children:e.jsxs("div",{className:"training-access-message",children:[e.jsx("h2",{children:"LoRA Training"}),e.jsx("p",{children:"Sign in with an admin account to manage training runs."})]})})};export{G as default};
