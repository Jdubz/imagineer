import{r as i,l as p,j as e}from"./index-1.0.1-2Be6sSou.js";import{u as I}from"./usePolling-1.0.1-DYzHV6Ky.js";import{v as J,s as U}from"./validation-1.0.1-Dy4TNGJh.js";const D=r=>typeof r=="number"?Math.min(100,Math.max(0,r)):void 0,k=r=>{if(typeof r!="number"||Number.isNaN(r))return"N/A";const f=r<10?1:0;return`${r.toLocaleString(void 0,{minimumFractionDigits:f,maximumFractionDigits:1})} GB`},$=({isAdmin:r=!1})=>{const[f,m]=i.useState([]),[g,S]=i.useState(!1),[N,y]=i.useState(!1),[w,o]=i.useState(null),[t,C]=i.useState(null),u=i.useCallback(async()=>{if(r)try{const s=await fetch("/api/scraping/jobs",{credentials:"include"});if(s.ok){const a=await s.json();m(a.jobs||[]),o(null)}else s.status===401||s.status===403?(m([]),o("You need admin access to view scrape jobs.")):o("Failed to fetch scrape jobs")}catch(s){o("Error fetching scrape jobs"),p.error("Error fetching jobs:",s)}},[r]),b=i.useCallback(async()=>{if(r)try{const s=await fetch("/api/scraping/stats",{credentials:"include"});if(s.ok){const a=await s.json();C(a)}}catch(s){p.error("Error fetching stats:",s)}},[r]);i.useEffect(()=>{r&&(u().catch(s=>p.error("Error refreshing jobs:",s)),b().catch(s=>p.error("Error refreshing stats:",s)))},[u,b,r]);const c=i.useCallback(async()=>{await Promise.all([u().catch(s=>p.error("Error refreshing jobs:",s)),b().catch(s=>p.error("Error refreshing stats:",s))])},[u,b]);I(c,{interval:5e3,enabled:r,pauseWhenHidden:!0});const x=async(s,a,j,l,_)=>{if(r){y(!0),o(null);try{const h=await fetch("/api/scraping/start",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({url:s,name:a,description:j,depth:l,max_images:_})});if(h.ok)await h.json(),await u(),S(!1);else{const F=await h.json();o(F.error||"Failed to start scrape job")}}catch(h){o("Error starting scrape job"),p.error("Error starting scrape:",h)}finally{y(!1)}}},E=async s=>{if(r)try{(await fetch(`/api/scraping/jobs/${s}/cancel`,{method:"POST",credentials:"include"})).ok?await u():o("Failed to cancel job")}catch(a){o("Error cancelling job"),p.error("Error cancelling job:",a)}},n=async s=>{if(r)try{(await fetch(`/api/scraping/jobs/${s}/cleanup`,{method:"POST",credentials:"include"})).ok?await u():o("Failed to cleanup job")}catch(a){o("Error cleaning up job"),p.error("Error cleaning up job:",a)}},d=s=>{switch(s){case"pending":return"#f39c12";case"running":return"#3498db";case"completed":return"#27ae60";case"failed":return"#e74c3c";case"cancelled":return"#95a5a6";case"cleaned_up":return"#7f8c8d";default:return"#95a5a6"}},v=s=>s?new Date(s).toLocaleString():"N/A";return r?e.jsxs("div",{className:"scraping-tab",children:[e.jsxs("div",{className:"scraping-header",children:[e.jsx("h2",{children:"Web Scraping"}),r&&e.jsx("button",{className:"start-scrape-btn",onClick:()=>S(!0),disabled:N,children:N?"Starting...":"Start New Scrape"})]}),w&&e.jsx("div",{className:"error-message",children:w}),t&&e.jsxs("div",{className:"scraping-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Total Jobs"}),e.jsx("span",{className:"stat-number",children:t.total_jobs})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Images Scraped"}),e.jsx("span",{className:"stat-number",children:t.total_images_scraped})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Recent Jobs (7 days)"}),e.jsx("span",{className:"stat-number",children:t.recent_jobs})]}),t.storage&&e.jsxs("div",{className:"stat-card storage-card",children:[e.jsx("h3",{children:"Storage Free"}),e.jsx("span",{className:"stat-number",children:k(t.storage.free_gb)}),t.storage.error?e.jsx("div",{className:"storage-error",children:t.storage.error}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"storage-details",children:[k(t.storage.used_gb)," used · ",k(t.storage.total_gb)," total"]}),typeof t.storage.free_percent=="number"&&e.jsxs("div",{className:"storage-details",children:[t.storage.free_percent.toFixed(1),"% free"]})]}),e.jsx("div",{className:"storage-path",children:t.storage.path})]})]}),e.jsx("div",{className:"scrape-jobs-list",children:f.length===0?e.jsx("div",{className:"no-jobs",children:e.jsx("p",{children:"No scrape jobs found. Start a new scrape to begin collecting training data."})}):f.map(s=>{const a=s.runtime??{},j=s.url??s.source_url??"Unknown URL",l=s.output_dir??s.output_directory,_=D(s.progress)??D(a.progress),h=s.progress_message??a.last_message??"";return e.jsxs("div",{className:`scrape-job-card status-${s.status}`,children:[e.jsxs("div",{className:"job-header",children:[e.jsx("h3",{children:j}),e.jsx("span",{className:"status-badge",style:{backgroundColor:d(s.status)},children:s.status})]}),e.jsxs("div",{className:"job-details",children:[e.jsxs("div",{className:"detail",children:[e.jsx("strong",{children:"URL:"}),e.jsx("a",{href:j,target:"_blank",rel:"noopener noreferrer",className:"job-url",children:j})]}),l&&e.jsxs("div",{className:"detail",children:[e.jsx("strong",{children:"Output Directory:"}),e.jsx("span",{children:l})]}),s.status==="running"&&e.jsxs("div",{className:"progress-section",children:[_!==void 0&&e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${_}%`}})}),(a.stage||h)&&e.jsxs("div",{className:"runtime-stage",children:[a.stage&&e.jsx("strong",{children:a.stage.charAt(0).toUpperCase()+a.stage.slice(1)}),h&&e.jsxs("span",{className:"runtime-message",children:[a.stage?" · ":"",h]})]}),(a.discovered!=null||a.downloaded!=null)&&e.jsxs("div",{className:"runtime-metrics",children:[a.discovered!=null&&e.jsxs("span",{children:["Links discovered: ",a.discovered]}),a.downloaded!=null&&e.jsxs("span",{children:["Images downloaded: ",a.downloaded]})]}),s.images_scraped!=null&&s.images_scraped>0&&e.jsx("div",{className:"stats",children:e.jsxs("span",{children:["Images scraped: ",s.images_scraped]})})]}),s.status==="completed"&&s.images_scraped!=null&&e.jsxs("div",{className:"completion-stats",children:[e.jsxs("div",{className:"success-message",children:["✓ Successfully scraped ",s.images_scraped," images"]}),l&&e.jsxs("div",{className:"output-info",children:["Output: ",l]})]}),s.status==="failed"&&s.error&&e.jsxs("div",{className:"error-details",children:[e.jsx("strong",{children:"Error:"}),e.jsx("span",{className:"error-text",children:s.error})]}),e.jsxs("div",{className:"job-meta",children:[e.jsxs("div",{className:"meta-item",children:[e.jsx("strong",{children:"Created:"})," ",v(s.created_at)]}),s.completed_at&&e.jsxs("div",{className:"meta-item",children:[e.jsx("strong",{children:"Completed:"})," ",v(s.completed_at)]}),a.updated_at&&e.jsxs("div",{className:"meta-item",children:[e.jsx("strong",{children:"Updated:"})," ",v(a.updated_at)]})]})]}),r&&e.jsxs("div",{className:"job-actions",children:[s.status==="running"&&e.jsx("button",{className:"cancel-btn",onClick:()=>E(s.id),children:"Cancel"}),(s.status==="completed"||s.status==="failed"||s.status==="cancelled")&&e.jsx("button",{className:"cleanup-btn",onClick:()=>n(s.id),children:"Cleanup"})]})]},s.id)})}),g&&e.jsx(L,{onClose:()=>S(!1),onSubmit:x,loading:N})]}):e.jsx("div",{className:"scraping-tab",children:e.jsxs("div",{className:"scraping-access-message",children:[e.jsx("h2",{children:"Web Scraping"}),e.jsx("p",{children:"Admin access required to manage scraping jobs."})]})})},L=({onClose:r,onSubmit:f,loading:m})=>{const[g,S]=i.useState(""),[N,y]=i.useState(""),[w,o]=i.useState(""),[t,C]=i.useState("3"),[u,b]=i.useState("1000"),[c,x]=i.useState({}),E=n=>{n.preventDefault(),x({});const d=N||`Scrape ${g}`,v=w||`Web scraping job for ${g}`,s=t.trim()===""?Number.NaN:Number(t),a=u.trim()===""?Number.NaN:Number(u),j={url:g.trim(),name:d,description:v,depth:s,maxImages:a},l=J(U,j);if(!l.success){x(l.errors),p.warn("Scrape form validation failed:",l.errors);return}f(l.data.url,l.data.name||d,l.data.description||v,l.data.depth,l.data.maxImages)};return e.jsx("div",{className:"dialog-overlay",onClick:r,children:e.jsxs("div",{className:"dialog",onClick:n=>n.stopPropagation(),children:[e.jsx("h2",{children:"Start Web Scrape"}),e.jsxs("form",{onSubmit:E,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"url",children:"URL to Scrape *"}),e.jsx("input",{id:"url",type:"url",value:g,onChange:n=>{if(S(n.target.value),c.url){const d={...c};delete d.url,x(d)}},placeholder:"https://example.com/gallery",required:!0,disabled:m,className:c.url?"error":""}),c.url&&e.jsx("span",{className:"error-message",children:c.url})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"name",children:"Job Name"}),e.jsx("input",{id:"name",type:"text",value:N,onChange:n=>y(n.target.value),placeholder:"Auto-generated from URL",disabled:m})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",value:w,onChange:n=>o(n.target.value),placeholder:"Optional description for this scraping job",rows:3,disabled:m})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"depth",children:"Max Depth"}),e.jsx("input",{id:"depth",type:"number",value:t,onChange:n=>{if(C(n.target.value),c.depth){const d={...c};delete d.depth,x(d)}},min:"1",max:"10",disabled:m,className:c.depth?"error":""}),e.jsx("small",{children:"How many links deep to follow (1-5)"}),c.depth&&e.jsx("span",{className:"error-message",children:c.depth})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"maxImages",children:"Max Images"}),e.jsx("input",{id:"maxImages",type:"number",value:u,onChange:n=>{if(b(n.target.value),c.maxImages){const d={...c};delete d.maxImages,x(d)}},min:"1",max:"10000",disabled:m,className:c.maxImages?"error":""}),e.jsx("small",{children:"Maximum images to download (1-10000)"}),c.maxImages&&e.jsx("span",{className:"error-message",children:c.maxImages})]})]}),e.jsxs("div",{className:"dialog-actions",children:[e.jsx("button",{type:"submit",className:"submit-btn",disabled:m||!g,children:m?"Starting...":"Start Scrape"}),e.jsx("button",{type:"button",onClick:r,disabled:m,children:"Cancel"})]})]})]})})};export{$ as default};
