import{r as l,l as p,j as e}from"./index-1.0.1-Bc4FHz3R.js";import{u as I}from"./usePolling-1.0.1-DLeCTzVN.js";import{v as J,s as U}from"./validation-1.0.1-CJscdRzZ.js";const D=r=>typeof r=="number"?Math.min(100,Math.max(0,r)):void 0,k=r=>{if(typeof r!="number"||Number.isNaN(r))return"N/A";const x=r<10?1:0;return`${r.toLocaleString(void 0,{minimumFractionDigits:x,maximumFractionDigits:1})} GB`},$=({isAdmin:r=!1})=>{const[x,d]=l.useState([]),[h,v]=l.useState(!1),[j,y]=l.useState(!1),[S,i]=l.useState(null),[c,C]=l.useState(null),m=l.useCallback(async()=>{if(r)try{const s=await fetch("/api/scraping/jobs",{credentials:"include"});if(s.ok){const a=await s.json();d(a.jobs||[]),i(null)}else s.status===401||s.status===403?(d([]),i("You need admin access to view scrape jobs.")):i("Failed to fetch scrape jobs")}catch(s){i("Error fetching scrape jobs"),p.error("Error fetching jobs:",s)}},[r]),f=l.useCallback(async()=>{if(r)try{const s=await fetch("/api/scraping/stats",{credentials:"include"});if(s.ok){const a=await s.json();C(a)}}catch(s){p.error("Error fetching stats:",s)}},[r]);l.useEffect(()=>{r&&(m().catch(s=>p.error("Error refreshing jobs:",s)),f().catch(s=>p.error("Error refreshing stats:",s)))},[m,f,r]);const t=l.useCallback(async()=>{await Promise.all([m().catch(s=>p.error("Error refreshing jobs:",s)),f().catch(s=>p.error("Error refreshing stats:",s))])},[m,f]);I(t,{interval:5e3,enabled:r,pauseWhenHidden:!0});const g=async(s,a,w,N,_)=>{if(r){y(!0),i(null);try{const u=await fetch("/api/scraping/start",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({url:s,name:a,description:w,depth:N,max_images:_})});if(u.ok)await u.json(),await m(),v(!1);else{const F=await u.json();i(F.error||"Failed to start scrape job")}}catch(u){i("Error starting scrape job"),p.error("Error starting scrape:",u)}finally{y(!1)}}},E=async s=>{if(r)try{(await fetch(`/api/scraping/jobs/${s}/cancel`,{method:"POST",credentials:"include"})).ok?await m():i("Failed to cancel job")}catch(a){i("Error cancelling job"),p.error("Error cancelling job:",a)}},n=async s=>{if(r)try{(await fetch(`/api/scraping/jobs/${s}/cleanup`,{method:"POST",credentials:"include"})).ok?await m():i("Failed to cleanup job")}catch(a){i("Error cleaning up job"),p.error("Error cleaning up job:",a)}},o=s=>{switch(s){case"pending":return"#f39c12";case"running":return"#3498db";case"completed":return"#27ae60";case"failed":return"#e74c3c";case"cancelled":return"#95a5a6";case"cleaned_up":return"#7f8c8d";default:return"#95a5a6"}},b=s=>s?new Date(s).toLocaleString():"N/A";return r?e.jsxs("div",{className:"scraping-tab",children:[e.jsxs("div",{className:"scraping-header",children:[e.jsx("h2",{children:"Web Scraping"}),r&&e.jsx("button",{className:"start-scrape-btn",onClick:()=>v(!0),disabled:j,children:j?"Starting...":"Start New Scrape"})]}),S&&e.jsx("div",{className:"error-message",children:S}),c&&e.jsxs("div",{className:"scraping-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Total Jobs"}),e.jsx("span",{className:"stat-number",children:c.total_jobs})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Images Scraped"}),e.jsx("span",{className:"stat-number",children:c.total_images_scraped})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Recent Jobs (7 days)"}),e.jsx("span",{className:"stat-number",children:c.recent_jobs})]}),c.storage&&e.jsxs("div",{className:"stat-card storage-card",children:[e.jsx("h3",{children:"Storage Free"}),e.jsx("span",{className:"stat-number",children:k(c.storage.free_gb)}),c.storage.error?e.jsx("div",{className:"storage-error",children:c.storage.error}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"storage-details",children:[k(c.storage.used_gb)," used · ",k(c.storage.total_gb)," total"]}),typeof c.storage.free_percent=="number"&&e.jsxs("div",{className:"storage-details",children:[c.storage.free_percent.toFixed(1),"% free"]})]}),e.jsx("div",{className:"storage-path",children:c.storage.path})]})]}),e.jsx("div",{className:"scrape-jobs-list",children:x.length===0?e.jsx("div",{className:"no-jobs",children:e.jsx("p",{children:"No scrape jobs found. Start a new scrape to begin collecting training data."})}):x.map(s=>{const a=s.runtime??{},w=s.url??s.source_url??"Unknown URL",N=s.output_dir??s.output_directory,_=D(s.progress)??D(a.progress),u=s.progress_message??a.last_message??"";return e.jsxs("div",{className:`scrape-job-card status-${s.status}`,children:[e.jsxs("div",{className:"job-header",children:[e.jsx("h3",{children:w}),e.jsx("span",{className:"status-badge",style:{backgroundColor:o(s.status)},children:s.status})]}),e.jsxs("div",{className:"job-details",children:[e.jsxs("div",{className:"detail",children:[e.jsx("strong",{children:"URL:"}),e.jsx("a",{href:w,target:"_blank",rel:"noopener noreferrer",className:"job-url",children:w})]}),N&&e.jsxs("div",{className:"detail",children:[e.jsx("strong",{children:"Output Directory:"}),e.jsx("span",{children:N})]}),s.status==="running"&&e.jsxs("div",{className:"progress-section",children:[_!==void 0&&e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${_}%`}})}),(a.stage||u)&&e.jsxs("div",{className:"runtime-stage",children:[a.stage&&e.jsx("strong",{children:a.stage.charAt(0).toUpperCase()+a.stage.slice(1)}),u&&e.jsxs("span",{className:"runtime-message",children:[a.stage?" · ":"",u]})]}),(a.discovered!=null||a.downloaded!=null)&&e.jsxs("div",{className:"runtime-metrics",children:[a.discovered!=null&&e.jsxs("span",{children:["Links discovered: ",a.discovered]}),a.downloaded!=null&&e.jsxs("span",{children:["Images downloaded: ",a.downloaded]})]}),s.images_scraped!=null&&s.images_scraped>0&&e.jsx("div",{className:"stats",children:e.jsxs("span",{children:["Images scraped: ",s.images_scraped]})})]}),s.status==="completed"&&s.images_scraped!=null&&e.jsxs("div",{className:"completion-stats",children:[e.jsxs("div",{className:"success-message",children:["✓ Successfully scraped ",s.images_scraped," images"]}),N&&e.jsxs("div",{className:"output-info",children:["Output: ",N]})]}),s.status==="failed"&&s.error&&e.jsxs("div",{className:"error-details",children:[e.jsx("strong",{children:"Error:"}),e.jsx("span",{className:"error-text",children:s.error})]}),e.jsxs("div",{className:"job-meta",children:[e.jsxs("div",{className:"meta-item",children:[e.jsx("strong",{children:"Created:"})," ",b(s.created_at)]}),s.completed_at&&e.jsxs("div",{className:"meta-item",children:[e.jsx("strong",{children:"Completed:"})," ",b(s.completed_at)]}),a.updated_at&&e.jsxs("div",{className:"meta-item",children:[e.jsx("strong",{children:"Updated:"})," ",b(a.updated_at)]})]})]}),r&&e.jsxs("div",{className:"job-actions",children:[s.status==="running"&&e.jsx("button",{className:"cancel-btn",onClick:()=>E(s.id),children:"Cancel"}),(s.status==="completed"||s.status==="failed"||s.status==="cancelled")&&e.jsx("button",{className:"cleanup-btn",onClick:()=>n(s.id),children:"Cleanup"})]})]},s.id)})}),h&&e.jsx(L,{onClose:()=>v(!1),onSubmit:g,loading:j})]}):e.jsx("div",{className:"scraping-tab",children:e.jsxs("div",{className:"scraping-access-message",children:[e.jsx("h2",{children:"Web Scraping"}),e.jsx("p",{children:"Admin access required to manage scraping jobs."})]})})},L=({onClose:r,onSubmit:x,loading:d})=>{const[h,v]=l.useState(""),[j,y]=l.useState(""),[S,i]=l.useState(""),[c,C]=l.useState(3),[m,f]=l.useState(1e3),[t,g]=l.useState({}),E=n=>{n.preventDefault(),g({});const o=j||`Scrape ${h}`,b=S||`Web scraping job for ${h}`,s={url:h.trim(),name:o,description:b,depth:c,maxImages:m},a=J(U,s);if(!a.success){g(a.errors),p.warn("Scrape form validation failed:",a.errors);return}x(a.data.url,a.data.name||o,a.data.description||b,a.data.depth,a.data.maxImages)};return e.jsx("div",{className:"dialog-overlay",onClick:r,children:e.jsxs("div",{className:"dialog",onClick:n=>n.stopPropagation(),children:[e.jsx("h2",{children:"Start Web Scrape"}),e.jsxs("form",{onSubmit:E,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"url",children:"URL to Scrape *"}),e.jsx("input",{id:"url",type:"url",value:h,onChange:n=>{if(v(n.target.value),t.url){const o={...t};delete o.url,g(o)}},placeholder:"https://example.com/gallery",required:!0,disabled:d,className:t.url?"error":""}),t.url&&e.jsx("span",{className:"error-message",children:t.url})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"name",children:"Job Name"}),e.jsx("input",{id:"name",type:"text",value:j,onChange:n=>y(n.target.value),placeholder:"Auto-generated from URL",disabled:d})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",value:S,onChange:n=>i(n.target.value),placeholder:"Optional description for this scraping job",rows:3,disabled:d})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"depth",children:"Max Depth"}),e.jsx("input",{id:"depth",type:"number",value:c,onChange:n=>{if(C(parseInt(n.target.value)),t.depth){const o={...t};delete o.depth,g(o)}},min:"1",max:"10",disabled:d,className:t.depth?"error":""}),e.jsx("small",{children:"How many links deep to follow (1-5)"}),t.depth&&e.jsx("span",{className:"error-message",children:t.depth})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"maxImages",children:"Max Images"}),e.jsx("input",{id:"maxImages",type:"number",value:m,onChange:n=>{if(f(parseInt(n.target.value)),t.maxImages){const o={...t};delete o.maxImages,g(o)}},min:"1",max:"10000",disabled:d,className:t.maxImages?"error":""}),e.jsx("small",{children:"Maximum images to download (1-10000)"}),t.maxImages&&e.jsx("span",{className:"error-message",children:t.maxImages})]})]}),e.jsxs("div",{className:"dialog-actions",children:[e.jsx("button",{type:"submit",className:"submit-btn",disabled:d||!h,children:d?"Starting...":"Start Scrape"}),e.jsx("button",{type:"button",onClick:r,disabled:d,children:"Cancel"})]})]})]})})};export{$ as default};
